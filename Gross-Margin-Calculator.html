<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS Gross Margin Calculator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            padding: 20px; 
            min-height: 100vh; 
        }
        .container { max-width: 1200px; margin: 0 auto; }
        
        header { text-align: center; color: white; margin-bottom: 30px; }
        h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .subtitle { font-size: 1.1em; opacity: 0.95; }
        
        .card { 
            background: white; 
            border-radius: 12px; 
            padding: 25px; 
            margin-bottom: 20px; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.1); 
        }
        
        .section-header { 
            font-size: 1.5em; 
            font-weight: 600; 
            color: #2d3748; 
            margin-bottom: 20px; 
            padding-bottom: 15px; 
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .input-group {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .input-label {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .help-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 0.8em;
            cursor: help;
            font-weight: bold;
        }
        
        .tooltip {
            display: none;
            position: absolute;
            background: #2d3748;
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.85em;
            max-width: 250px;
            z-index: 1000;
            font-weight: normal;
        }
        
        .help-icon:hover + .tooltip {
            display: block;
        }
        
        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .input-field:focus {
            border-color: #667eea;
        }
        
        .input-with-prefix {
            display: flex;
            align-items: center;
        }
        
        .input-prefix {
            background: #e2e8f0;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-right: none;
            border-radius: 6px 0 0 6px;
            font-weight: 600;
            color: #4a5568;
        }
        
        .input-with-prefix .input-field {
            border-radius: 0 6px 6px 0;
        }
        
        .category-total {
            background: #edf2f7;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #2d3748;
        }
        
        .category-total-value {
            font-size: 1.3em;
            color: #667eea;
        }
        
        .results-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .result-box {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .result-value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .result-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .result-sublabel {
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .benchmark-bar {
            margin-top: 30px;
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 10px;
        }
        
        .benchmark-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .benchmark-scale {
            display: flex;
            height: 40px;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .benchmark-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .benchmark-poor { background: #e53e3e; flex: 1; }
        .benchmark-fair { background: #f97316; flex: 1; }
        .benchmark-good { background: #48bb78; flex: 1; }
        .benchmark-excellent { background: #16a34a; flex: 1; }
        
        .benchmark-marker {
            position: relative;
            height: 10px;
        }
        
        .marker-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 15px solid white;
            transform: translateX(-10px);
        }
        
        .breakdown-chart {
            margin-top: 20px;
        }
        
        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .chart-label {
            width: 200px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .chart-visual {
            flex: 1;
            height: 30px;
            background: #667eea;
            border-radius: 5px;
            position: relative;
            margin: 0 10px;
        }
        
        .chart-percentage {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .chart-value {
            width: 100px;
            text-align: right;
            font-weight: 600;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .action-btn-primary {
            background: #48bb78;
            color: white;
        }
        
        .action-btn-primary:hover {
            background: #38a169;
            transform: translateY(-2px);
        }
        
        .action-btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid white;
        }
        
        .action-btn-secondary:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }
        
        .insights-box {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .insights-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .insight-item {
            margin: 10px 0;
            padding-left: 25px;
            position: relative;
        }
        
        .insight-item:before {
            content: "‚Ä¢";
            position: absolute;
            left: 10px;
            font-size: 1.5em;
        }
        
        .add-item-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
            transition: background 0.3s;
        }
        
        .add-item-btn:hover {
            background: #5568d3;
        }
        
        .custom-cost-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .custom-cost-item input {
            flex: 1;
        }
        
        .delete-btn {
            padding: 8px 15px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
        
        @media print {
            body { background: white; }
            .action-buttons { display: none !important; }
        }
    </style>
</head>
<body>

<div class="controls">
  <button class="btn" onclick="window.location.href='Goal Seek.html'">Goal Seek</button>
    <button class="btn" onclick="window.location.href='SaaS-Growth-Sim.html'">Monte Carlo Sim</button>
<button class="btn" onclick="window.location.href='Unit-Economics-Calculator.html'">Monte Carlo Sim</button>

</div>

<div class="container">
    <header>
        <h1>üí∞ SaaS Gross Margin Calculator</h1>
        <p class="subtitle">Calculate your true gross margin by tracking all COGS components</p>
    </header>

    <div class="card">
        <div class="section-header">
            <span>üìä</span> Revenue
        </div>
        
        <div class="input-group">
            <div class="input-label">
                <span>
                    Annual Recurring Revenue (ARR)
                    <span class="help-icon">?</span>
                    <span class="tooltip">Total contracted annual revenue from all customers</span>
                </span>
            </div>
            <div class="input-with-prefix">
                <span class="input-prefix">‚Ç¨</span>
                <input type="number" class="input-field" id="arr" value="250000" oninput="calculateMargin()" min="0">
            </div>
        </div>

        <div class="input-group">
            <div class="input-label">
                <span>
                    Average Contract Value (ACV)
                    <span class="help-icon">?</span>
                    <span class="tooltip">Average annual revenue per customer</span>
                </span>
            </div>
            <div class="input-with-prefix">
                <span class="input-prefix">‚Ç¨</span>
                <input type="number" class="input-field" id="acv" value="15000" oninput="calculateMargin()" min="0">
            </div>
        </div>

        <div class="category-total">
            <span>Total Customers:</span>
            <span class="category-total-value" id="total-customers">17</span>
        </div>
    </div>

    <div class="two-column">
        <div>
            <div class="card">
                <div class="section-header">
                    <span>‚òÅÔ∏è</span> Hosting & Infrastructure
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span>
                            Cloud Hosting (AWS/Azure/GCP)
                            <span class="help-icon">?</span>
                            <span class="tooltip">Monthly cost for servers, databases, storage</span>
                        </span>
                    </div>
                    <div class="input-with-prefix">
                        <span class="input-prefix">‚Ç¨</span>
                        <input type="number" class="input-field" id="hosting" value="2500" oninput="calculateMargin()" min="0">
                        <span style="padding: 12px; color: #718096;">/month</span>
                    </div>
                </div>

                <div class="input-group">
                    <div class="input-label">
                        <span>
                            CDN & Bandwidth
                            <span class="help-icon">?</span>
                            <span class="tooltip">Content delivery network and data transfer costs</span>
                        </span>
                    </div>
                    <div class="input-with-prefix">
                        <span class="input-prefix">‚Ç¨</span>
                        <input type="number" class="input-field" id="cdn" value="500" oninput="calculateMargin()" min="0">
                        <span style="padding: 12px; color: #718096;">/month</span>
                    </div>
                </div>

                <div class="input-group">
                    <div class="input-label">
                        <span>
                            Monitoring & Security Tools
                            <span class="help-icon">?</span>
                            <span class="tooltip">DataDog, New Relic, security services</span>
                        </span>
                    </div>
                    <div class="input-with-prefix">
                        <span class="input-prefix">‚Ç¨</span>
                        <input type="number" class="input-field" id="monitoring" value="400" oninput="calculateMargin()" min="0">
                        <span style="padding: 12px; color: #718096;">/month</span>
                    </div>
                </div>

                <div class="category-total">
                    <span>Annual Infrastructure Cost:</span>
                    <span class="category-total-value" id="infrastructure-total">‚Ç¨40,800</span>
                </div>
            </div>

            <div class="card">
                <div class="section-header">
                    <span>ü§ù</span> Customer Success
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span>
                            Number of CSMs
                            <span class="help-icon">?</span>
                            <span class="tooltip">Customer Success Managers handling onboarding and retention</span>
                        </span>
                    </div>
                    <input type="number" class="input-field" id="csm-count" value="1" oninput="calculateMargin()" min="0" step="0.5">
                </div>

                <div class="input-group">
                    <div class="input-label">
                        <span>
                            Avg Fully-Loaded Cost per CSM
                            <span class="help-icon">?</span>
                            <span class="tooltip">Salary + benefits + taxes (typically 1.3-1.5x base salary)</span>
                        </span>
                    </div>
                    <div class="input-with-prefix">
                        <span class="input-prefix">‚Ç¨</span>
                        <input type="number" class="input-field" id="csm-cost" value="75000" oninput="calculateMargin()" min="0">
                        <span style="padding: 12px; color: #718096;">/year</span>
                    </div>
                </div>

                <div class="input-group">
                    <div class="input-label">
                        <span>
                            CS Tools & Software
                            <span class="help-icon">?</span>
                            <span class="tooltip">Gainsight, ChurnZero, analytics tools</span>
                        </span>
                    </div>
                    <div class="input-with-prefix">
                        <span class="input-prefix">‚Ç¨</span>
                        <input type="number" class="input-field" id="cs-tools" value="5000" oninput="calculateMargin()" min="0">
                        <span style="padding: 12px; color: #718096;">/year</span>
                    </div>
                </div>

                <div class="category-total">
                    <span>Annual CS Cost:</span>
                    <span class="category-total-value" id="cs-total">‚Ç¨80,000</span>
                </div>
            </div>
        </div>

        <div>
            <div class="card">
                <div class="section-header">
                    <span>üí¨</span> Customer Support
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span>
                            Number of Support Staff
                            <span class="help-icon">?</span>
                            <span class="tooltip">Support agents handling tickets and customer issues</span>
                        </span>
                    </div>
                    <input type="number" class="input-field" id="support-count" value="2" oninput="calculateMargin()" min="0" step="0.5">
                </div>

                <div class="input-group">
                    <div class="input-label">
                        <span>
                            Avg Fully-Loaded Cost per Agent
                            <span class="help-icon">?</span>
                            <span class="tooltip">Salary + benefits + taxes</span>
                        </span>
                    </div>
                    <div class="input-with-prefix">
                        <span class="input-prefix">‚Ç¨</span>
                        <input type="number" class="input-field" id="support-cost" value="55000" oninput="calculateMargin()" min="0">
                        <span style="padding: 12px; color: #718096;">/year</span>
                    </div>
                </div>

                <div class="input-group">
                    <div class="input-label">
                        <span>
                            Support Tools
                            <span class="help-icon">?</span>
                            <span class="tooltip">Zendesk, Intercom, help desk software</span>
                        </span>
                    </div>
                    <div class="input-with-prefix">
                        <span class="input-prefix">‚Ç¨</span>
                        <input type="number" class="input-field" id="support-tools" value="6000" oninput="calculateMargin()" min="0">
                        <span style="padding: 12px; color: #718096;">/year</span>
                    </div>
                </div>

                <div class="category-total">
                    <span>Annual Support Cost:</span>
                    <span class="category-total-value" id="support-total">‚Ç¨116,000</span>
                </div>
            </div>

            <div class="card">
                <div class="section-header">
                    <span>üîß</span> Third-Party Services
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span>
                            Payment Processing (%)
                            <span class="help-icon">?</span>
                            <span class="tooltip">Stripe, PayPal fees (typically 2.5-3%)</span>
                        </span>
                    </div>
                    <div class="input-with-prefix">
                        <input type="number" class="input-field" id="payment-rate" value="2.5" oninput="calculateMargin()" min="0" max="10" step="0.1">
                        <span style="padding: 12px; color: #718096;">%</span>
                    </div>
                </div>

                <div class="input-group">
                    <div class="input-label">
                        <span>
                            API & Integration Costs
                            <span class="help-icon">?</span>
                            <span class="tooltip">Third-party APIs, data providers, integrations</span>
                        </span>
                    </div>
                    <div class="input-with-prefix">
                        <span class="input-prefix">‚Ç¨</span>
                        <input type="number" class="input-field" id="api-costs" value="8000" oninput="calculateMargin()" min="0">
                        <span style="padding: 12px; color: #718096;">/year</span>
                    </div>
                </div>

                <div class="input-group">
                    <div class="input-label">
                        <span>
                            Professional Services Delivery
                            <span class="help-icon">?</span>
                            <span class="tooltip">Implementation, training, consulting delivered to customers</span>
                        </span>
                    </div>
                    <div class="input-with-prefix">
                        <span class="input-prefix">‚Ç¨</span>
                        <input type="number" class="input-field" id="prof-services" value="0" oninput="calculateMargin()" min="0">
                        <span style="padding: 12px; color: #718096;">/year</span>
                    </div>
                </div>

                <div class="category-total">
                    <span>Annual Third-Party Cost:</span>
                    <span class="category-total-value" id="thirdparty-total">‚Ç¨14,250</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="section-header">
            <span>‚ûï</span> Custom Costs
        </div>
        <div id="custom-costs-container"></div>
        <button class="add-item-btn" onclick="addCustomCost()">+ Add Custom Cost</button>
        
        <div class="category-total" style="margin-top: 20px;">
            <span>Total Custom Costs:</span>
            <span class="category-total-value" id="custom-total">‚Ç¨0</span>
        </div>
    </div>

    <div class="card">
        <div class="results-section">
            <h2 style="text-align: center; margin-bottom: 10px;">Your Gross Margin Results</h2>
            
            <div class="results-grid">
                <div class="result-box">
                    <div class="result-value" id="gross-margin-pct">0%</div>
                    <div class="result-label">Gross Margin</div>
                    <div class="result-sublabel" id="margin-rating">Calculating...</div>
                </div>
                
                <div class="result-box">
                    <div class="result-value" id="total-cogs">‚Ç¨0</div>
                    <div class="result-label">Total Annual COGS</div>
                    <div class="result-sublabel" id="cogs-per-customer">‚Ç¨0 per customer</div>
                </div>
                
                <div class="result-box">
                    <div class="result-value" id="gross-profit">‚Ç¨0</div>
                    <div class="result-label">Gross Profit</div>
                    <div class="result-sublabel">Annual</div>
                </div>
                
                <div class="result-box">
                    <div class="result-value" id="cac-payback">0</div>
                    <div class="result-label">CAC Payback Period</div>
                    <div class="result-sublabel">With ‚Ç¨12,429 CAC</div>
                </div>
            </div>

            <div class="benchmark-bar">
                <div class="benchmark-title">Industry Benchmark Comparison</div>
                <div class="benchmark-scale">
                    <div class="benchmark-segment benchmark-poor">&lt; 40%</div>
                    <div class="benchmark-segment benchmark-fair">40-60%</div>
                    <div class="benchmark-segment benchmark-good">60-75%</div>
                    <div class="benchmark-segment benchmark-excellent">&gt; 75%</div>
                </div>
                <div class="benchmark-marker" id="benchmark-marker">
                    <div class="marker-arrow"></div>
                </div>
                <div style="text-align: center; margin-top: 10px; font-size: 0.9em;">
                    <strong>Your margin:</strong> <span id="your-margin-display">0%</span>
                </div>
            </div>

            <div class="breakdown-chart">
                <h3 style="margin-bottom: 15px;">COGS Breakdown by Category</h3>
                <div id="breakdown-bars"></div>
            </div>

            <div class="insights-box" id="insights-box"></div>

            <div class="action-buttons">
                <button class="action-btn action-btn-primary" onclick="exportToPDF()">üìÑ Export to PDF</button>
                <button class="action-btn action-btn-secondary" onclick="saveData()">üíæ Save Calculation</button>
                <button class="action-btn action-btn-secondary" onclick="resetToDefaults()">üîÑ Reset to Defaults</button>
            </div>
        </div>
    </div>
</div>

<script>
let customCostCounter = 0;

function calculateMargin() {
    // Get revenue values
    const arr = parseFloat(document.getElementById('arr').value) || 0;
    const acv = parseFloat(document.getElementById('acv').value) || 0;
    const totalCustomers = acv > 0 ? Math.round(arr / acv) : 0;
    
    document.getElementById('total-customers').textContent = totalCustomers;
    
    // Calculate infrastructure costs (monthly to annual)
    const hosting = (parseFloat(document.getElementById('hosting').value) || 0) * 12;
    const cdn = (parseFloat(document.getElementById('cdn').value) || 0) * 12;
    const monitoring = (parseFloat(document.getElementById('monitoring').value) || 0) * 12;
    const infrastructureTotal = hosting + cdn + monitoring;
    
    document.getElementById('infrastructure-total').textContent = '‚Ç¨' + infrastructureTotal.toLocaleString();
    
    // Calculate CS costs
    const csmCount = parseFloat(document.getElementById('csm-count').value) || 0;
    const csmCost = parseFloat(document.getElementById('csm-cost').value) || 0;
    const csTools = parseFloat(document.getElementById('cs-tools').value) || 0;
    const csTotal = (csmCount * csmCost) + csTools;
    
    document.getElementById('cs-total').textContent = '‚Ç¨' + csTotal.toLocaleString();
    
    // Calculate support costs
    const supportCount = parseFloat(document.getElementById('support-count').value) || 0;
    const supportCost = parseFloat(document.getElementById('support-cost').value) || 0;
    const supportTools = parseFloat(document.getElementById('support-tools').value) || 0;
    const supportTotal = (supportCount * supportCost) + supportTools;
    
    document.getElementById('support-total').textContent = '‚Ç¨' + supportTotal.toLocaleString();
    
    // Calculate third-party costs
    const paymentRate = parseFloat(document.getElementById('payment-rate').value) || 0;
    const paymentCosts = arr * (paymentRate / 100);
    const apiCosts = parseFloat(document.getElementById('api-costs').value) || 0;
    const profServices = parseFloat(document.getElementById('prof-services').value) || 0;
    const thirdPartyTotal = paymentCosts + apiCosts + profServices;
    
    document.getElementById('thirdparty-total').textContent = '‚Ç¨' + thirdPartyTotal.toLocaleString();
    
    // Calculate custom costs
    let customTotal = 0;
    document.querySelectorAll('.custom-cost-value').forEach(input => {
        customTotal += parseFloat(input.value) || 0;
    });
    
    document.getElementById('custom-total').textContent = '‚Ç¨' + customTotal.toLocaleString();
    
    // Calculate total COGS
    const totalCOGS = infrastructureTotal + csTotal + supportTotal + thirdPartyTotal + customTotal;
    
    // Calculate gross margin
    const grossProfit = arr - totalCOGS;
    const grossMarginPct = arr > 0 ? (grossProfit / arr) * 100 : 0;
    
    // Update results
    document.getElementById('gross-margin-pct').textContent = grossMarginPct.toFixed(1) + '%';
    document.getElementById('total-cogs').textContent = '‚Ç¨' + totalCOGS.toLocaleString();
    document.getElementById('cogs-per-customer').textContent = totalCustomers > 0 ? '‚Ç¨' + (totalCOGS / totalCustomers).toLocaleString() + ' per customer' : '‚Ç¨0 per customer';
    document.getElementById('gross-profit').textContent = '‚Ç¨' + grossProfit.toLocaleString();
    document.getElementById('your-margin-display').textContent = grossMarginPct.toFixed(1) + '%';
    
    // Calculate CAC payback
    const cac = 12429; // From earlier calculation
    const monthlyRevenue = acv / 12;
    const monthlyGrossProfit = monthlyRevenue * (grossMarginPct / 100);
    const cacPayback = monthlyGrossProfit > 0 ? cac / monthlyGrossProfit : 0;
    
    document.getElementById('cac-payback').textContent = cacPayback.toFixed(1) + ' months';
    
    // Update margin rating
    let rating = '';
    if (grossMarginPct >= 75) rating = 'üéâ Excellent!';
    else if (grossMarginPct >= 60) rating = '‚úÖ Good';
    else if (grossMarginPct >= 40) rating = '‚ö†Ô∏è Fair';
    else rating = 'üî¥ Needs Improvement';
    
    document.getElementById('margin-rating').textContent = rating;
    
    // Position benchmark marker
    const markerPosition = Math.min(Math.max(grossMarginPct, 0), 100);
    document.getElementById('benchmark-marker').style.marginLeft = markerPosition + '%';
    
    // Generate breakdown chart
    generateBreakdownChart(infrastructureTotal, csTotal, supportTotal, thirdPartyTotal, customTotal, totalCOGS);
    
    // Generate insights
    generateInsights(grossMarginPct, totalCOGS, arr, infrastructureTotal, csTotal, supportTotal, cacPayback);
}

function generateBreakdownChart(infra, cs, support, thirdParty, custom, total) {
    const container = document.getElementById('breakdown-bars');
    
    const categories = [
        { label: 'Infrastructure', value: infra, color: '#667eea' },
        { label: 'Customer Success', value: cs, color: '#48bb78' },
        { label: 'Customer Support', value: support, color: '#f97316' },
        { label: 'Third-Party Services', value: thirdParty, color: '#5a67d8' },
        { label: 'Custom Costs', value: custom, color: '#9f7aea' }
    ];
    
    container.innerHTML = categories.map(cat => {
        const percentage = total > 0 ? (cat.value / total) * 100 : 0;
        return `
            <div class="chart-bar">
                <div class="chart-label">${cat.label}</div>
                <div class="chart-visual" style="background: ${cat.color}; width: ${percentage}%;">
                    <span class="chart-percentage">${percentage.toFixed(1)}%</span>
                </div>
                <div class="chart-value">‚Ç¨${cat.value.toLocaleString()}</div>
            </div>
        `;
    }).join('');
}

function generateInsights(margin, cogs, arr, infra, cs, support, cacPayback) {
    const container = document.getElementById('insights-box');
    let insights = [];
    
    insights.push('<div class="insights-title">üí° Key Insights & Recommendations</div>');
    
    // Margin insights
    if (margin < 40) {
        insights.push('<div class="insight-item">Your gross margin is below typical SaaS benchmarks. Consider ways to reduce COGS or increase pricing.</div>');
    } else if (margin >= 75) {
        insights.push('<div class="insight-item">Excellent gross margin! You\'re operating at best-in-class efficiency.</div>');
    }
    
    // Component insights
    const infraPct = (infra / cogs) * 100;
    const supportPct = ((cs + support) / cogs) * 100;
    
    if (infraPct > 25) {
        insights.push('<div class="insight-item">Infrastructure costs are ' + infraPct.toFixed(0) + '% of COGS. Consider optimizing cloud spend or negotiating better rates.</div>');
    }
    
    if (supportPct > 70) {
        insights.push('<div class="insight-item">People costs (CS + Support) represent ' + supportPct.toFixed(0) + '% of COGS. Automating onboarding and support could improve margins.</div>');
    }
    
    // CAC payback insight
    if (cacPayback > 18) {
        insights.push('<div class="insight-item">CAC payback of ' + cacPayback.toFixed(1) + ' months is lengthy. Improving gross margin or reducing CAC would help.</div>');
    } else if (cacPayback < 12) {
        insights.push('<div class="insight-item">CAC payback under 12 months is excellent! You\'re recovering acquisition costs quickly.</div>');
    }
    
    // Scale insights
    const cogsPerCustomer = arr > 0 ? cogs / (arr / 15000) : 0;
    if (cogsPerCustomer > 10000) {
        insights.push('<div class="insight-item">High COGS per customer (‚Ç¨' + cogsPerCustomer.toFixed(0) + '). As you scale, focus on operational efficiency to reduce per-customer costs.</div>');
    }
    
    // Revenue insights
    if (arr < 500000 && margin < 50) {
        insights.push('<div class="insight-item">At your revenue stage, 40-50% gross margin is acceptable. Focus on growth and improving margins as you scale.</div>');
    }
    
    container.innerHTML = insights.join('');
}

function addCustomCost() {
    customCostCounter++;
    const container = document.getElementById('custom-costs-container');
    
    const costDiv = document.createElement('div');
    costDiv.className = 'custom-cost-item';
    costDiv.id = 'custom-cost-' + customCostCounter;
    costDiv.innerHTML = `
        <input type="text" class="input-field custom-cost-name" placeholder="Cost name (e.g., Data licenses)" style="flex: 2;">
        <div class="input-with-prefix" style="flex: 1;">
            <span class="input-prefix">‚Ç¨</span>
            <input type="number" class="input-field custom-cost-value" placeholder="0" oninput="calculateMargin()" min="0">
        </div>
        <button class="delete-btn" onclick="removeCustomCost(${customCostCounter})">Delete</button>
    `;
    
    container.appendChild(costDiv);
}

function removeCustomCost(id) {
    const element = document.getElementById('custom-cost-' + id);
    if (element) {
        element.remove();
        calculateMargin();
    }
}

function saveData() {
    const data = {
        arr: document.getElementById('arr').value,
        acv: document.getElementById('acv').value,
        hosting: document.getElementById('hosting').value,
        cdn: document.getElementById('cdn').value,
        monitoring: document.getElementById('monitoring').value,
        csmCount: document.getElementById('csm-count').value,
        csmCost: document.getElementById('csm-cost').value,
        csTools: document.getElementById('cs-tools').value,
        supportCount: document.getElementById('support-count').value,
        supportCost: document.getElementById('support-cost').value,
        supportTools: document.getElementById('support-tools').value,
        paymentRate: document.getElementById('payment-rate').value,
        apiCosts: document.getElementById('api-costs').value,
        profServices: document.getElementById('prof-services').value
    };
    
    localStorage.setItem('grossMarginCalc', JSON.stringify(data));
    alert('‚úÖ Calculation saved! It will be loaded automatically next time.');
}

function loadSavedData() {
    const saved = localStorage.getItem('grossMarginCalc');
    if (saved) {
        const data = JSON.parse(saved);
        Object.keys(data).forEach(key => {
            const element = document.getElementById(key);
            if (element) element.value = data[key];
        });
    }
}

function resetToDefaults() {
    if (confirm('Reset all values to defaults?')) {
        document.getElementById('arr').value = 250000;
        document.getElementById('acv').value = 15000;
        document.getElementById('hosting').value = 2500;
        document.getElementById('cdn').value = 500;
        document.getElementById('monitoring').value = 400;
        document.getElementById('csm-count').value = 1;
        document.getElementById('csm-cost').value = 75000;
        document.getElementById('cs-tools').value = 5000;
        document.getElementById('support-count').value = 2;
        document.getElementById('support-cost').value = 55000;
        document.getElementById('support-tools').value = 6000;
        document.getElementById('payment-rate').value = 2.5;
        document.getElementById('api-costs').value = 8000;
        document.getElementById('prof-services').value = 0;
        
        document.getElementById('custom-costs-container').innerHTML = '';
        customCostCounter = 0;
        
        calculateMargin();
    }
}

function exportToPDF() {
    const style = document.createElement('style');
    style.textContent = `
        @media print {
            body { background: white; }
            .action-buttons, .add-item-btn, .delete-btn { display: none !important; }
            .card { page-break-inside: avoid; }
            .results-section { background: #667eea !important; -webkit-print-color-adjust: exact; }
        }
    `;
    document.head.appendChild(style);
    
    window.print();
    
    setTimeout(() => document.head.removeChild(style), 1000);
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    loadSavedData();
    calculateMargin();
});
</script>
</body>
</html>