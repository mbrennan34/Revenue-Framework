<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BearOps Sales Trigger Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn.active {
            background: rgba(76, 175, 80, 0.8);
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-tab:hover, .nav-tab.active {
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1rem;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-sublabel {
            font-size: 0.85rem;
            color: #999;
        }

        .bucket-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .bucket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .bucket-title {
            font-size: 1.5rem;
            color: #4a5568;
            font-weight: 600;
        }

        .bucket-stats {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: #666;
        }

        .bucket-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .bucket-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }

        .add-customer-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .add-customer-btn:hover {
            background: #388e3c;
            transform: scale(1.05);
        }

        .customers-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .customers-table th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #ddd;
        }

        .customers-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .customers-table tr:hover {
            background: #f9f9f9;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-contacted {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-responded {
            background: #e8f5e9;
            color: #388e3c;
        }

        .status-meeting {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-qualified {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .status-new {
            background: #fce4ec;
            color: #c2185b;
        }

        .action-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 5px;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #1976d2;
        }

        .action-btn.delete {
            background: #f44336;
        }

        .action-btn.delete:hover {
            background: #d32f2f;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            margin: 20px;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }

        .close:hover {
            color: black;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
            transition: transform 0.3s ease;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.5rem;
            color: #4a5568;
            margin-bottom: 20px;
            text-align: center;
        }

        .bar-chart {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 300px;
            gap: 20px;
            padding: 20px 0;
        }

        .bar {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px 8px 0 0;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            transition: all 0.3s ease;
        }

        .bar:hover {
            opacity: 0.8;
            transform: translateY(-5px);
        }

        .bar-value {
            position: absolute;
            top: -30px;
            font-weight: 700;
            color: #333;
            font-size: 1.2rem;
        }

        .bar-label {
            text-align: center;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #666;
            word-wrap: break-word;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            z-index: 10000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

.controls {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    backdrop-filter: blur(10px);
}

.btn {
    padding: 12px 24px;
    margin: 0 10px 10px 10px;
    background: white;
    color: #667eea;
    border: 2px solid white;
    border-radius: 8px;
    font-size: 1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}
    </style>
</head>
<body>

<div class="controls">
    <button class="btn" onclick="window.location.href='sales-triggers2.html'"> Prospect Tracker</button>
    <button class="btn" onclick="window.location.href='Command-Message.html'">Command of Message </button>
<button class="btn" onclick="window.location.href='Discovery-Workshop.html'">Discovery Workshop</button>
<button class="btn" onclick="window.location.href='Miller-Heiman.html'">Heiman Miller</button>
<button class="btn" onclick="window.location.href='one2one3.html'">1:1 Tracker</button>
<button class="btn" onclick="window.location.href='BattleCards.html'">Battle Cards</button>



</div>

    <div class="container">
        <div class="header">
            <h1>Prospect by Trigger </h1>
            <p>Track target customers across key trigger buckets</p>
        </div>

        <div class="controls">
            <button class="btn" id="editToggle">Enable Editing</button>
            <button class="btn" onclick="saveData()">Save Data</button>
            <button class="btn" onclick="loadData()">Load Data</button>
            <button class="btn" onclick="exportData()">Export to JSON</button>
            <button class="btn" onclick="exportToExcel()">Export to Excel</button>
            <button class="btn" onclick="document.getElementById('excelUpload').click()">Import Excel</button>
            <button class="btn" onclick="syncAllToHubSpot()">Sync All to HubSpot</button>
            <button class="btn" onclick="openHubSpotSettings()">HubSpot Settings</button>
        
            <input type="file" id="excelUpload" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelUpload(event)">
        </div>


        <div class="nav-tabs">
            <button class="nav-tab active" data-view="dashboard">Dashboard</button>
            <button class="nav-tab" data-view="buckets">All Buckets</button>
            <button class="nav-tab" data-view="funding">Funding Rounds</button>
            <button class="nav-tab" data-view="expansion">Team Expansion</button>
            <button class="nav-tab" data-view="leadership">GTM Leadership</button>
            <button class="nav-tab" data-view="tech">Tech Stack</button>
            <button class="nav-tab" data-view="international">International</button>
            <button class="nav-tab" data-view="efficiency">High Burn</button>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard" class="view active">
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalCustomers">0</div>
                    <div class="stat-label">Total Target Customers</div>
                    <div class="stat-sublabel">Across all buckets</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalContacted">0</div>
                    <div class="stat-label">Customers Contacted</div>
                    <div class="stat-sublabel">Total outreach</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalResponded">0</div>
                    <div class="stat-label">Responses Received</div>
                    <div class="stat-sublabel">Engagement rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgResponseRate">0%</div>
                    <div class="stat-label">Avg Response Rate</div>
                    <div class="stat-sublabel">Across all buckets</div>
                </div>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">Customers by Trigger Bucket</h3>
                <div class="bar-chart" id="bucketChart"></div>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">Response Rates by Bucket</h3>
                <div class="bar-chart" id="responseChart"></div>
            </div>
        </div>

        <!-- All Buckets View -->
        <div id="buckets" class="view">
            <div class="bucket-section">
                <h2 style="text-align: center; color: #4a5568; margin-bottom: 30px;">All Trigger Buckets Overview</h2>
                <div id="allBucketsContainer"></div>
            </div>
        </div>

        <!-- Individual Bucket Views -->
        <div id="funding" class="view">
            <div class="bucket-section">
                <div class="bucket-header">
                    <div>
                        <h2 class="bucket-title">Funding Rounds (Seed / Series A / B)</h2>
                        <p style="color: #666; margin-top: 5px;">Fresh capital, investor pressure, need for repeatable growth</p>
                    </div>
                    <button class="add-customer-btn" onclick="openModal('funding')">+ Add Customer</button>
                </div>
                <div class="bucket-stats">
                    <div class="bucket-stat">
                        <span class="bucket-stat-value" id="funding-count">0</span>
                        <span>Customers</span>
                    </div>
                    <div class="bucket-stat">
                        <span class="bucket-stat-value" id="funding-contacted">0</span>
                        <span>Contacted</span>
                    </div>
                    <div class="bucket-stat">
                        <span class="bucket-stat-value" id="funding-response">0%</span>
                        <span>Response Rate</span>
                    </div>
                </div>
                <div id="funding-table"></div>
            </div>
        </div>

        <div id="expansion" class="view">
            <div class="bucket-section">
                <div class="bucket-header">
                    <div>
                        <h2 class="bucket-title">Team Expansion / Headcount Growth</h2>
                        <p style="color: #666; margin-top: 5px;">5â†’15+ people, alignment challenges, hiring framework needs</p>
                    </div>
                    <button class="add-customer-btn" onclick="openModal('expansion')">+ Add Customer</button>
                </div>
                <div class="bucket-stats">
                    <div class="bucket-stat">
                        <span class="bucket-stat-value" id="expansion-count">0</span>
                        <span>Customers</span>
                    </div>
                    <div class="bucket-stat">
                        <span class="bucket-stat-value" id="expansion-contacted">0</span>
                        <span>Contacted</span>
                    </div>
                    <div class="bucket-stat">
                        <span class="bucket-stat-value" id="expansion-response">0%</span>
                        <span>Response Rate</span>
                    </div>
                </div>
                <div id="expansion-table"></div>
            </div>
        </div>

        <div id="leadership" class="view">
            <div class="bucket-section">
                <div class="bucket-header">
                    <div>
                        <h2 class="bucket-title">New GTM or Revenue Leadership Hires</h2>
                        <p style="color: #666; margin-top: 5px;">First CRO/VP Sales, need for playbooks & structure</p>
                    </div>
                    <button class="add-customer-btn" onclick="openModal('leadership')">+ Add Customer</button>
                </div>
                <div class="bucket-stats">
                    <div class="bucket-stat">
                        <span class="bucket-stat-value" id="leadership-count">0</span>
                        <span>Customers</span>
                    </div>
                    <div class="bucket-stat">
                        <span class="bucket-stat-value" id="leadership-contacted">0</span>
                        <span>Contacted</span>
                    </div>
                    <div class="bucket-stat">
                        <span class="bucket-stat-value" id="leadership-response">0%</span>
                        <span>Response Rate</span>
                    </div>
                </div>
                <div id="leadership-table"></div>
            </div>
        </div>

        <div id="tech" class="view">
            <div class="bucket-section">
                <div class="bucket-header">
                    <div>
                        <h2 class="bucket-title">Tech Stack Adoption / Change</h2>
                        <p style="color: #666; margin-top: 5px;">Salesforce/HubSpot adoption, need for RevOps structure</p>
                    </div>
                    <button class="add-customer-btn" onclick="openModal('tech')">+ Add Customer</button>
                </div>
                <div class="bucket-stats">
                    <div class="bucket-stat">
                        <span class="bucket-stat-value" id="tech-count">0</span>
                        <span>Customers</span>
                    </div>
                    <div class="bucket-stat">
                        <span class="bucket-stat-value" id="tech-contacted">0</span>
                        <span>Contacted</span>
                    </div>
                    <div class="bucket-stat">
                        <span class="bucket-stat-value" id="tech-response">0%</span>
                        <span>Response Rate</span>
                    </div>
                </div>
                <div id="tech-table"></div>
            </div>
        </div>

        <div id="international" class="view">
            <div class="bucket-section">
                <div class="bucket-header">
                    <div>
                        <h2 class="bucket-title">International Expansion / Market Entry</h2>
                        <p style="color: #666; margin-top: 5px;">Expanding to US/EU, ICP clarity needed</p>
                    </div>
                    <button class="add-customer-btn" onclick="openModal('international')">+ Add Customer</button>
                </div>
                <div class="bucket-stats">
                    <div class="bucket-stat">
                        <span class="bucket-stat-value" id="international-count">0</span>
                        <span>Customers</span>
                    </div>
                    <div class="bucket-stat">
                        <span class="bucket-stat-value" id="international-contacted">0</span>
                        <span>Contacted</span>
                    </div>
                    <div class="bucket-stat">
                        <span class="bucket-stat-value" id="international-response">0%</span>
                        <span>Response Rate</span>
                    </div>
                </div>
                <div id="international-table"></div>
            </div>
        </div>

        <div id="efficiency" class="view">
            <div class="bucket-section">
                <div class="bucket-header">
                    <div>
                        <h2 class="bucket-title">High Burn / Operational Inefficiency</h2>
                        <p style="color: #666; margin-top: 5px;">Investor pressure, burn multiple focus, revenue predictability</p>
                    </div>
                    <button class="add-customer-btn" onclick="openModal('efficiency')">+ Add Customer</button>
                </div>
                <div class="bucket-stats">
                    <div class="bucket-stat">
                        <span class="bucket-stat-value" id="efficiency-count">0</span>
                        <span>Customers</span>
                    </div>
                    <div class="bucket-stat">
                        <span class="bucket-stat-value" id="efficiency-contacted">0</span>
                        <span>Contacted</span>
                    </div>
                    <div class="bucket-stat">
                        <span class="bucket-stat-value" id="efficiency-response">0%</span>
                        <span>Response Rate</span>
                    </div>
                </div>
                <div id="efficiency-table"></div>
            </div>
        </div>
    </div>

    <!-- HubSpot Settings Modal -->
    <div id="hubspotModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">HubSpot Integration Settings</h2>
                <button class="close" onclick="closeHubSpotSettings()">&times;</button>
            </div>
            <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; color: #1565c0;">
                <strong>Setup Instructions:</strong>
                <ol style="margin: 10px 0 0 20px;">
                    <li>Create a HubSpot Form or get your API endpoint</li>
                    <li>Enter the endpoint URL below</li>
                    <li>Map your form fields to match customer data</li>
                    <li>Click "Test Connection" to verify</li>
                </ol>
            </div>
            <form id="hubspotForm" onsubmit="saveHubSpotSettings(event)">
                <div class="form-group">
                    <label>HubSpot Form/API Endpoint URL *</label>
                    <input type="url" id="hubspotEndpoint" placeholder="https://api.hsforms.com/submissions/v3/integration/submit/..." required>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        Find this in HubSpot: Marketing â†’ Forms â†’ Share â†’ Get embed code (look for the submission URL)
                    </small>
                </div>
                
                <div class="form-group">
                    <label>Portal ID</label>
                    <input type="text" id="hubspotPortalId" placeholder="12345678">
                </div>
                
                <div class="form-group">
                    <label>Form GUID</label>
                    <input type="text" id="hubspotFormGuid" placeholder="abc-123-def-456">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="autoSync"> Enable automatic sync to HubSpot when adding/updating customers
                    </label>
                </div>
                
                <button type="submit" class="submit-btn">Save Settings</button>
                <button type="button" class="submit-btn" onclick="testHubSpotConnection()" style="margin-top: 10px; background: #4CAF50;">Test Connection</button>
            </form>
        </div>
    </div>

    <!-- Add/Edit Customer Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add Customer</h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <form id="customerForm" onsubmit="saveCustomer(event)">
                <input type="hidden" id="customerId">
                <input type="hidden" id="customerBucket">
                
                <div class="form-group">
                    <label>Company Name *</label>
                    <input type="text" id="companyName" required>
                </div>
                
                <div class="form-group">
                    <label>Contact Person</label>
                    <input type="text" id="contactPerson">
                </div>
                
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email">
                </div>
                
                <div class="form-group">
                    <label>Status *</label>
                    <select id="status" required>
                        <option value="new">New - Not Contacted</option>
                        <option value="contacted">Contacted - Awaiting Response</option>
                        <option value="responded">Responded</option>
                        <option value="meeting">Meeting Scheduled</option>
                        <option value="qualified">Qualified Opportunity</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Trigger Details</label>
                    <textarea id="triggerDetails" placeholder="e.g., Announced Series A funding of â‚¬5M..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="notes" placeholder="Additional notes about this prospect..."></textarea>
                </div>
                
                <button type="submit" class="submit-btn">Save Customer</button>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Data structure
        let customersData = {
            funding: [],
            expansion: [],
            leadership: [],
            tech: [],
            international: [],
            efficiency: []
        };

        let editMode = false;
        let editingCustomerId = null;
        
        // HubSpot settings
        let hubspotSettings = {
            endpoint: '',
            portalId: '',
            formGuid: '',
            autoSync: false
        };

        // Load HubSpot settings from storage
        function loadHubSpotSettings() {
            const saved = localStorage.getItem('hubspotSettings');
            if (saved) {
                hubspotSettings = JSON.parse(saved);
            }
        }

        // Open HubSpot settings modal
        function openHubSpotSettings() {
            document.getElementById('hubspotModal').classList.add('active');
            document.getElementById('hubspotEndpoint').value = hubspotSettings.endpoint || '';
            document.getElementById('hubspotPortalId').value = hubspotSettings.portalId || '';
            document.getElementById('hubspotFormGuid').value = hubspotSettings.formGuid || '';
            document.getElementById('autoSync').checked = hubspotSettings.autoSync || false;
        }

        // Close HubSpot settings modal
        function closeHubSpotSettings() {
            document.getElementById('hubspotModal').classList.remove('active');
        }

        // Save HubSpot settings
        function saveHubSpotSettings(event) {
            event.preventDefault();
            
            hubspotSettings = {
                endpoint: document.getElementById('hubspotEndpoint').value,
                portalId: document.getElementById('hubspotPortalId').value,
                formGuid: document.getElementById('hubspotFormGuid').value,
                autoSync: document.getElementById('autoSync').checked
            };
            
            localStorage.setItem('hubspotSettings', JSON.stringify(hubspotSettings));
            showToast('HubSpot settings saved');
            closeHubSpotSettings();
        }

        // Test HubSpot connection
        async function testHubSpotConnection() {
            if (!hubspotSettings.endpoint && !hubspotSettings.portalId) {
                showToast('Please configure HubSpot settings first');
                return;
            }
            
            try {
                const testData = {
                    companyName: 'Test Company',
                    contactPerson: 'Test Contact',
                    email: 'test@example.com',
                    status: 'new',
                    triggerDetails: 'Connection test',
                    notes: 'This is a test submission'
                };
                
                await sendToHubSpot(testData, 'funding');
                showToast('Connection test successful! Check your HubSpot for the test submission.');
            } catch (error) {
                showToast('Connection test failed: ' + error.message);
            }
        }

        // Send customer data to HubSpot
        async function sendToHubSpot(customer, bucket) {
            if (!hubspotSettings.endpoint && !hubspotSettings.portalId) {
                throw new Error('HubSpot not configured');
            }

            // Method 1: Using HubSpot Forms API (most common)
            if (hubspotSettings.portalId && hubspotSettings.formGuid) {
                const url = `https://api.hsforms.com/submissions/v3/integration/submit/${hubspotSettings.portalId}/${hubspotSettings.formGuid}`;
                
                const payload = {
                    fields: [
                        { name: 'company', value: customer.companyName },
                        { name: 'firstname', value: customer.contactPerson?.split(' ')[0] || '' },
                        { name: 'lastname', value: customer.contactPerson?.split(' ').slice(1).join(' ') || '' },
                        { name: 'email', value: customer.email || '' },
                        { name: 'trigger_bucket', value: bucket },
                        { name: 'trigger_details', value: customer.triggerDetails || '' },
                        { name: 'deal_stage', value: customer.status }
                    ],
                    context: {
                        pageUri: window.location.href,
                        pageName: 'BearOps Sales Tracker'
                    }
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HubSpot API error: ${response.status}`);
                }

                return await response.json();
            }
            
            // Method 2: Using custom webhook/endpoint
            if (hubspotSettings.endpoint) {
                const response = await fetch(hubspotSettings.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...customer,
                        bucket: bucket
                    })
                });

                if (!response.ok) {
                    throw new Error(`Webhook error: ${response.status}`);
                }

                return await response.json();
            }
        }

        // Sync customer to HubSpot
        async function syncCustomerToHubSpot(bucket, customerId) {
            if (!hubspotSettings.autoSync && !confirm('Sync this customer to HubSpot?')) {
                return;
            }

            const customer = customersData[bucket].find(c => c.id === customerId);
            if (!customer) return;

            try {
                await sendToHubSpot(customer, bucket);
                showToast('Customer synced to HubSpot successfully');
            } catch (error) {
                showToast('Failed to sync to HubSpot: ' + error.message);
                console.error('HubSpot sync error:', error);
            }
        }

        // Sync all customers to HubSpot
        async function syncAllToHubSpot() {
            if (!hubspotSettings.endpoint && !hubspotSettings.portalId) {
                showToast('Please configure HubSpot settings first');
                openHubSpotSettings();
                return;
            }

            if (!confirm('This will sync ALL customers to HubSpot. Continue?')) {
                return;
            }

            let synced = 0;
            let failed = 0;

            for (const bucket of Object.keys(customersData)) {
                for (const customer of customersData[bucket]) {
                    try {
                        await sendToHubSpot(customer, bucket);
                        synced++;
                        // Small delay to avoid rate limiting
                        await new Promise(resolve => setTimeout(resolve, 500));
                    } catch (error) {
                        failed++;
                        console.error(`Failed to sync ${customer.companyName}:`, error);
                    }
                }
            }

            showToast(`Sync complete: ${synced} succeeded, ${failed} failed`);
        }

        // Handle Excel file upload
        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get the first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        showToast('No data found in Excel file');
                        return;
                    }
                    
                    // Process the data
                    importExcelData(jsonData);
                    
                } catch (error) {
                    showToast('Error reading Excel file: ' + error.message);
                    console.error(error);
                }
            };
            
            reader.readAsArrayBuffer(file);
            event.target.value = ''; // Reset input
        }

        function importExcelData(jsonData) {
            let imported = 0;
            let skipped = 0;
            
            jsonData.forEach(row => {
                // Map Excel columns to our data structure
                // Expected columns: Company Name, Contact Person, Email, Bucket, Status, Trigger Details, Notes
                
                const companyName = row['Company Name'] || row['Company'] || row['company_name'] || '';
                const bucket = (row['Bucket'] || row['bucket'] || 'funding').toLowerCase().trim();
                
                if (!companyName) {
                    skipped++;
                    return;
                }
                
                // Validate bucket
                const validBuckets = ['funding', 'expansion', 'leadership', 'tech', 'international', 'efficiency'];
                const targetBucket = validBuckets.includes(bucket) ? bucket : 'funding';
                
                // Map status
                let status = (row['Status'] || row['status'] || 'new').toLowerCase().trim();
                const validStatuses = ['new', 'contacted', 'responded', 'meeting', 'qualified'];
                if (!validStatuses.includes(status)) {
                    status = 'new';
                }
                
                const customer = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    companyName: companyName,
                    contactPerson: row['Contact Person'] || row['Contact'] || row['contact_person'] || '',
                    email: row['Email'] || row['email'] || '',
                    status: status,
                    triggerDetails: row['Trigger Details'] || row['Trigger'] || row['trigger_details'] || '',
                    notes: row['Notes'] || row['notes'] || '',
                    dateAdded: new Date().toISOString()
                };
                
                customersData[targetBucket].push(customer);
                imported++;
            });
            
            saveToStorage();
            renderAll();
            showToast(`Imported ${imported} customers${skipped > 0 ? `, skipped ${skipped} rows` : ''}`);
        }

        // Export data to Excel
        function exportToExcel() {
            const allCustomers = [];
            
            Object.keys(customersData).forEach(bucket => {
                customersData[bucket].forEach(customer => {
                    allCustomers.push({
                        'Company Name': customer.companyName,
                        'Contact Person': customer.contactPerson || '',
                        'Email': customer.email || '',
                        'Bucket': bucket,
                        'Status': formatStatus(customer.status),
                        'Trigger Details': customer.triggerDetails || '',
                        'Notes': customer.notes || '',
                        'Date Added': new Date(customer.dateAdded).toLocaleDateString()
                    });
                });
            });
            
            if (allCustomers.length === 0) {
                showToast('No data to export');
                return;
            }
            
            // Create worksheet
            const worksheet = XLSX.utils.json_to_sheet(allCustomers);
            
            // Create workbook
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Customers');
            
            // Generate Excel file
            XLSX.writeFile(workbook, `bearops-customers-${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showToast('Data exported to Excel successfully');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadFromStorage();
            loadHubSpotSettings();
            renderAll();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const view = this.dataset.view;
                    showView(view);
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Edit toggle
            document.getElementById('editToggle').addEventListener('click', toggleEditMode);
        }

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            if (viewId === 'dashboard') {
                updateDashboard();
            } else if (viewId === 'buckets') {
                renderAllBuckets();
            } else if (viewId !== 'dashboard' && viewId !== 'buckets') {
                renderBucketTable(viewId);
            }
        }

        function toggleEditMode() {
            editMode = !editMode;
            const btn = document.getElementById('editToggle');
            if (editMode) {
                btn.textContent = 'Disable Editing';
                btn.classList.add('active');
                showToast('Edit mode enabled');
            } else {
                btn.textContent = 'Enable Editing';
                btn.classList.remove('active');
                showToast('Edit mode disabled');
            }
        }

        function openModal(bucket) {
            if (!editMode) {
                showToast('Enable editing mode first');
                return;
            }
            
            document.getElementById('customerModal').classList.add('active');
            document.getElementById('modalTitle').textContent = 'Add Customer';
            document.getElementById('customerForm').reset();
            document.getElementById('customerId').value = '';
            document.getElementById('customerBucket').value = bucket;
            editingCustomerId = null;
        }

        function closeModal() {
            document.getElementById('customerModal').classList.remove('active');
        }

        function saveCustomer(event) {
            event.preventDefault();
            
            const bucket = document.getElementById('customerBucket').value;
            const customerId = document.getElementById('customerId').value;
            
            const customer = {
                id: customerId || Date.now().toString(),
                companyName: document.getElementById('companyName').value,
                contactPerson: document.getElementById('contactPerson').value,
                email: document.getElementById('email').value,
                status: document.getElementById('status').value,
                triggerDetails: document.getElementById('triggerDetails').value,
                notes: document.getElementById('notes').value,
                dateAdded: customerId ? customersData[bucket].find(c => c.id === customerId).dateAdded : new Date().toISOString()
            };

            if (customerId) {
                // Update existing
                const index = customersData[bucket].findIndex(c => c.id === customerId);
                customersData[bucket][index] = customer;
                showToast('Customer updated');
            } else {
                // Add new
                customersData[bucket].push(customer);
                showToast('Customer added');
            }

            saveToStorage();
            renderAll();
            closeModal();
            
            // Auto-sync to HubSpot if enabled
            if (hubspotSettings.autoSync) {
                syncCustomerToHubSpot(bucket, customer.id);
            }
        }

        function editCustomer(bucket, customerId) {
            if (!editMode) {
                showToast('Enable editing mode first');
                return;
            }

            const customer = customersData[bucket].find(c => c.id === customerId);
            if (!customer) return;

            document.getElementById('customerModal').classList.add('active');
            document.getElementById('modalTitle').textContent = 'Edit Customer';
            document.getElementById('customerId').value = customer.id;
            document.getElementById('customerBucket').value = bucket;
            document.getElementById('companyName').value = customer.companyName;
            document.getElementById('contactPerson').value = customer.contactPerson || '';
            document.getElementById('email').value = customer.email || '';
            document.getElementById('status').value = customer.status;
            document.getElementById('triggerDetails').value = customer.triggerDetails || '';
            document.getElementById('notes').value = customer.notes || '';
            
            editingCustomerId = customerId;
        }

        function deleteCustomer(bucket, customerId) {
            if (!editMode) {
                showToast('Enable editing mode first');
                return;
            }

            if (confirm('Are you sure you want to delete this customer?')) {
                customersData[bucket] = customersData[bucket].filter(c => c.id !== customerId);
                saveToStorage();
                renderAll();
                showToast('Customer deleted');
            }
        }

        function renderBucketTable(bucket) {
            const customers = customersData[bucket];
            const container = document.getElementById(`${bucket}-table`);
            
            // Update stats
            const total = customers.length;
            const contacted = customers.filter(c => c.status !== 'new').length;
            const responded = customers.filter(c => ['responded', 'meeting', 'qualified'].includes(c.status)).length;
            const responseRate = contacted > 0 ? ((responded / contacted) * 100).toFixed(1) : 0;
            
            document.getElementById(`${bucket}-count`).textContent = total;
            document.getElementById(`${bucket}-contacted`).textContent = contacted;
            document.getElementById(`${bucket}-response`).textContent = responseRate + '%';
            
            if (customers.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ“Š</div><p>No customers added yet. Click "Add Customer" to get started.</p></div>';
                return;
            }
            
            let html = '<table class="customers-table"><thead><tr>';
            html += '<th>Company</th>';
            html += '<th>Contact</th>';
            html += '<th>Email</th>';
            html += '<th>Status</th>';
            html += '<th>Trigger Details</th>';
            html += '<th>Date Added</th>';
            if (editMode) html += '<th>Actions</th>';
            html += '</tr></thead><tbody>';
            
            customers.forEach(customer => {
                html += '<tr>';
                html += `<td><strong>${customer.companyName}</strong></td>`;
                html += `<td>${customer.contactPerson || '-'}</td>`;
                html += `<td>${customer.email || '-'}</td>`;
                html += `<td><span class="status-badge status-${customer.status}">${formatStatus(customer.status)}</span></td>`;
                html += `<td>${customer.triggerDetails ? customer.triggerDetails.substring(0, 50) + '...' : '-'}</td>`;
                html += `<td>${new Date(customer.dateAdded).toLocaleDateString()}</td>`;
                if (editMode) {
                    html += `<td>
                        <button class="action-btn" onclick="editCustomer('${bucket}', '${customer.id}')">Edit</button>
                        <button class="action-btn delete" onclick="deleteCustomer('${bucket}', '${customer.id}')">Delete</button>
                    </td>`;
                }
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function formatStatus(status) {
            const statuses = {
                'new': 'New',
                'contacted': 'Contacted',
                'responded': 'Responded',
                'meeting': 'Meeting Scheduled',
                'qualified': 'Qualified'
            };
            return statuses[status] || status;
        }

        function renderAllBuckets() {
            const container = document.getElementById('allBucketsContainer');
            const buckets = ['funding', 'expansion', 'leadership', 'tech', 'international', 'efficiency'];
            const bucketNames = {
                'funding': 'Funding Rounds',
                'expansion': 'Team Expansion',
                'leadership': 'GTM Leadership',
                'tech': 'Tech Stack',
                'international': 'International Expansion',
                'efficiency': 'High Burn / Efficiency'
            };
            
            let html = '';
            buckets.forEach(bucket => {
                const customers = customersData[bucket];
                const total = customers.length;
                const contacted = customers.filter(c => c.status !== 'new').length;
                const responded = customers.filter(c => ['responded', 'meeting', 'qualified'].includes(c.status)).length;
                const responseRate = contacted > 0 ? ((responded / contacted) * 100).toFixed(1) : 0;
                
                html += `
                    <div style="margin-bottom: 30px; padding: 20px; background: #f9f9f9; border-radius: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #4a5568;">${bucketNames[bucket]}</h3>
                            <button class="add-customer-btn" onclick="openModal('${bucket}')">+ Add</button>
                        </div>
                        <div style="display: flex; gap: 30px; margin-bottom: 10px;">
                            <div><strong>${total}</strong> customers</div>
                            <div><strong>${contacted}</strong> contacted</div>
                            <div><strong>${responded}</strong> responded</div>
                            <div><strong>${responseRate}%</strong> response rate</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateDashboard() {
            const buckets = ['funding', 'expansion', 'leadership', 'tech', 'international', 'efficiency'];
            
            // Calculate totals
            let totalCustomers = 0;
            let totalContacted = 0;
            let totalResponded = 0;
            
            const bucketData = [];
            const responseData = [];
            
            buckets.forEach(bucket => {
                const customers = customersData[bucket];
                const count = customers.length;
                const contacted = customers.filter(c => c.status !== 'new').length;
                const responded = customers.filter(c => ['responded', 'meeting', 'qualified'].includes(c.status)).length;
                const responseRate = contacted > 0 ? ((responded / contacted) * 100).toFixed(1) : 0;
                
                totalCustomers += count;
                totalContacted += contacted;
                totalResponded += responded;
                
                bucketData.push({ bucket, count });
                responseData.push({ bucket, rate: parseFloat(responseRate) });
            });
            
            const avgResponseRate = totalContacted > 0 ? ((totalResponded / totalContacted) * 100).toFixed(1) : 0;
            
            // Update stats
            document.getElementById('totalCustomers').textContent = totalCustomers;
            document.getElementById('totalContacted').textContent = totalContacted;
            document.getElementById('totalResponded').textContent = totalResponded;
            document.getElementById('avgResponseRate').textContent = avgResponseRate + '%';
            
            // Render charts
            renderBarChart('bucketChart', bucketData, 'count');
            renderBarChart('responseChart', responseData, 'rate');
        }

        function renderBarChart(containerId, data, valueKey) {
            const container = document.getElementById(containerId);
            const maxValue = Math.max(...data.map(d => d[valueKey]), 1);
            
            const bucketNames = {
                'funding': 'Funding',
                'expansion': 'Team Expansion',
                'leadership': 'GTM Leadership',
                'tech': 'Tech Stack',
                'international': 'International',
                'efficiency': 'High Burn'
            };
            
            let html = '';
            data.forEach(item => {
                const height = (item[valueKey] / maxValue) * 100;
                const value = valueKey === 'rate' ? item[valueKey].toFixed(1) + '%' : item[valueKey];
                
                html += `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                        <div class="bar" style="height: ${height}%; min-height: 30px; width: 100%;">
                            <div class="bar-value">${value}</div>
                        </div>
                        <div class="bar-label">${bucketNames[item.bucket]}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function renderAll() {
            updateDashboard();
            renderAllBuckets();
            ['funding', 'expansion', 'leadership', 'tech', 'international', 'efficiency'].forEach(bucket => {
                renderBucketTable(bucket);
            });
        }

        function saveData() {
            saveToStorage();
            showToast('Data saved successfully');
        }

        function loadData() {
            loadFromStorage();
            renderAll();
            showToast('Data loaded successfully');
        }

        function exportData() {
            const dataStr = JSON.stringify(customersData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `bearops-customers-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('Data exported successfully');
        }

        function saveToStorage() {
            localStorage.setItem('bearopsCustomers', JSON.stringify(customersData));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('bearopsCustomers');
            if (saved) {
                customersData = JSON.parse(saved);
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('customerModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
            